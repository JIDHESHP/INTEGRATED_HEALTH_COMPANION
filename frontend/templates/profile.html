{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 relative overflow-hidden">
    <!-- Animated Background -->
    <div class="absolute inset-0 opacity-20">
        <div
            class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width=\'100\' height=\'100\' viewBox=\'0 0 100 100\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3z\' fill=\'%23ffffff\' fill-opacity=\'0.3\'/%3E%3C/svg%3E')] animate-pulse">
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 relative z-10">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="inline-block p-4 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full mb-4">
                    <i class="fa-solid fa-user-circle text-white text-5xl"></i>
                </div>
                <h1 class="text-4xl md:text-5xl font-bold mb-4 gradient-text">Health Profile ðŸ‘¤</h1>
                <p class="text-gray-200 text-lg">Manage your personal health information</p>
            </div>

            <!-- Profile Form -->
            <div class="glass-card p-8 shadow-2xl mb-6">
                <h2 class="text-2xl font-bold text-white mb-6">
                    <i class="fa-solid fa-edit mr-2"></i>Personal Information
                </h2>
                <form id="profile-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-gray-300 mb-2 font-semibold">
                            <i class="fa-solid fa-user mr-2 text-primary"></i>Full Name
                        </label>
                        <input type="text" name="full_name" id="p-full-name"
                            class="w-full bg-gray-800/50 border-2 border-gray-700 rounded-lg p-4 text-white focus:outline-none focus:border-primary transition"
                            placeholder="e.g. John Doe">
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2 font-semibold">
                            <i class="fa-solid fa-birthday-cake mr-2 text-primary"></i>Age
                        </label>
                        <input type="number" name="age" id="p-age" min="1" max="120"
                            class="w-full bg-gray-800/50 border-2 border-gray-700 rounded-lg p-4 text-white focus:outline-none focus:border-primary transition">
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2 font-semibold">
                            <i class="fa-solid fa-venus-mars mr-2 text-primary"></i>Gender
                        </label>
                        <select name="gender" id="p-gender"
                            class="w-full bg-gray-800/50 border-2 border-gray-700 rounded-lg p-4 text-white focus:outline-none focus:border-primary transition">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2 font-semibold">
                            <i class="fa-solid fa-ruler-vertical mr-2 text-primary"></i>Height (cm)
                        </label>
                        <input type="number" name="height" id="p-height" min="50" max="250"
                            class="w-full bg-gray-800/50 border-2 border-gray-700 rounded-lg p-4 text-white focus:outline-none focus:border-primary transition">
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2 font-semibold">
                            <i class="fa-solid fa-weight mr-2 text-primary"></i>Weight (kg)
                        </label>
                        <input type="number" name="weight" id="p-weight" min="20" max="300" step="0.1"
                            class="w-full bg-gray-800/50 border-2 border-gray-700 rounded-lg p-4 text-white focus:outline-none focus:border-primary transition">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-300 mb-2 font-semibold">
                            <i class="fa-solid fa-running mr-2 text-primary"></i>Activity Level
                        </label>
                        <select name="activity_level" id="p-activity"
                            class="w-full bg-gray-800/50 border-2 border-gray-700 rounded-lg p-4 text-white focus:outline-none focus:border-primary transition">
                            <option value="sedentary">Sedentary (Little/No Exercise)</option>
                            <option value="moderate">Moderate (3-5 days/week)</option>
                            <option value="active">Active (Daily Exercise)</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit"
                            class="w-full bg-gradient-to-r from-primary to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-bold py-4 rounded-lg transition transform hover:scale-105 shadow-lg">
                            <i class="fa-solid fa-save mr-2"></i>Save Profile
                        </button>
                    </div>
                </form>

                <!-- Success Message -->
                <div id="save-success" class="hidden mt-4 p-4 bg-green-500/20 border border-green-500 rounded-lg">
                    <p class="text-green-300 font-semibold">
                        <i class="fa-solid fa-check-circle mr-2"></i>Profile saved successfully!
                    </p>
                </div>
            </div>

            <!-- BMI & Stats Display -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="glass-card p-6 text-center">
                    <div class="text-4xl mb-2">ðŸ“Š</div>
                    <h3 class="text-gray-400 text-sm uppercase mb-2">BMI</h3>
                    <div id="bmi-display" class="text-3xl font-bold text-primary">--</div>
                    <p id="bmi-status" class="text-xs text-gray-500 mt-2">--</p>
                </div>
                <div class="glass-card p-6 text-center">
                    <div class="text-4xl mb-2">ðŸ’ª</div>
                    <h3 class="text-gray-400 text-sm uppercase mb-2">Activity Level</h3>
                    <div id="activity-display" class="text-2xl font-bold text-secondary">--</div>
                </div>
                <div class="glass-card p-6 text-center">
                    <div class="text-4xl mb-2">ðŸŽ¯</div>
                    <h3 class="text-gray-400 text-sm uppercase mb-2">Health Status</h3>
                    <div id="health-status" class="text-2xl font-bold text-green-400">Good</div>
                </div>
            </div>

            <!-- Exercise Recommendations -->
            <div id="exercise-recommendations" class="glass-card p-6 hidden">
                <h3 class="text-xl font-bold text-white mb-4">
                    <i class="fa-solid fa-dumbbell mr-2 text-secondary"></i>Recommended Exercises
                </h3>
                <ul id="rec-list" class="space-y-2">
                    <!-- Recommendations will be populated by JS -->
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    const state = {
        token: localStorage.getItem('token')
    };

    if (!state.token) {
        window.location.href = '/login';
    }

    // Load profile on page load
    document.addEventListener('DOMContentLoaded', () => {
        fetchProfile();
    });

    // Form submission
    document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Saving...';

        try {
            const res = await fetch('/api/profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.token}`
                },
                body: JSON.stringify(data)
            });
            const resData = await res.json();

            if (res.ok) {
                const successMsg = document.getElementById('save-success');
                successMsg.classList.remove('hidden');
                setTimeout(() => successMsg.classList.add('hidden'), 3000);

                if (resData.bmi) {
                    updateBMI(resData.bmi);
                }
                if (resData.recommendations) {
                    displayRecommendations(resData.recommendations);
                }
                // Update prompt to update name on dashboard?
                // User can refresh.
            } else {
                alert('Error: ' + resData.msg);
            }
        } catch (err) {
            console.error(err);
            alert('Failed to save profile');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    });

    async function fetchProfile() {
        try {
            const res = await fetch('/api/profile', {
                headers: { 'Authorization': `Bearer ${state.token}` }
            });
            const data = await res.json();

            if (data) {
                if (data.full_name) document.getElementById('p-full-name').value = data.full_name;
                if (data.age) document.getElementById('p-age').value = data.age;
                if (data.gender) document.getElementById('p-gender').value = data.gender;
                if (data.height) document.getElementById('p-height').value = data.height;
                if (data.weight) document.getElementById('p-weight').value = data.weight;
                if (data.activity_level) document.getElementById('p-activity').value = data.activity_level;

                if (data.bmi) updateBMI(data.bmi);
                if (data.activity_level) {
                    document.getElementById('activity-display').textContent = data.activity_level.charAt(0).toUpperCase() + data.activity_level.slice(1);
                }
                if (data.recommended_exercises) {
                    displayRecommendations(data.recommended_exercises);
                }
            }
        } catch (err) {
            console.error('Failed to fetch profile:', err);
        }
    }

    function updateBMI(bmi) {
        document.getElementById('bmi-display').textContent = bmi.toFixed(1);
        const statusEl = document.getElementById('bmi-status');
        if (bmi < 18.5) {
            statusEl.textContent = 'Underweight';
            statusEl.className = 'text-xs text-blue-400 mt-2';
        } else if (bmi < 25) {
            statusEl.textContent = 'Normal';
            statusEl.className = 'text-xs text-green-400 mt-2';
        } else if (bmi < 30) {
            statusEl.textContent = 'Overweight';
            statusEl.className = 'text-xs text-yellow-400 mt-2';
        } else {
            statusEl.textContent = 'Obese';
            statusEl.className = 'text-xs text-red-400 mt-2';
        }
    }

    function displayRecommendations(recs) {
        const container = document.getElementById('exercise-recommendations');
        const list = document.getElementById('rec-list');
        list.innerHTML = '';
        recs.forEach(r => {
            const li = document.createElement('li');
            li.className = 'flex items-center p-3 bg-gray-800/50 rounded-lg';
            li.innerHTML = `<i class="fa-solid fa-check-circle text-secondary mr-3"></i><span class="text-gray-300">${r}</span>`;
            list.appendChild(li);
        });
        container.classList.remove('hidden');
    }
</script>
{% endblock %}