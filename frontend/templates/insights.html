{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-4xl font-bold mb-8 gradient-text">
            <i class="fa-solid fa-brain mr-3"></i>AI Health Insights
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Wellness Score -->
            <div class="glass-card p-6 flex flex-col items-center justify-center text-center relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent"></div>
                <div class="relative z-10">
                    <div
                        class="w-32 h-32 rounded-full border-4 border-emerald-500/30 flex items-center justify-center mb-4 relative">
                        <span class="text-4xl font-bold text-white" id="score-val">--</span>
                        <svg class="absolute inset-0 w-full h-full transform -rotate-90">
                            <circle cx="60" cy="60" r="58" stroke="currentColor" stroke-width="4" fill="none"
                                class="text-emerald-500" stroke-dasharray="365" stroke-dashoffset="55" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-white">Wellness Score</h3>
                    <p class="text-emerald-400 text-sm font-medium" id="score-text">Calculated from Vitals</p>
                </div>
            </div>

            <!-- AI Summary -->
            <div class="glass-card p-6 md:col-span-2 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-6 opacity-5">
                    <i class="fa-solid fa-robot text-8xl"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-4">Daily Analysis</h3>
                <div class="space-y-4">
                    <p class="text-slate-300 leading-relaxed" id="analysis-text">
                        Loading your latest health analysis...
                    </p>
                    <div class="flex flex-wrap gap-2" id="analysis-tags">
                        <!-- Tags inserted by JS -->
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Trends Analysis -->
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold text-white mb-6">Trend Analysis</h3>
                <div class="h-64 rounded-xl border border-white/5 p-2 bg-slate-900/50">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold text-white mb-6">Recommendations</h3>
                <div id="ai-recs" class="space-y-4">
                    <p class="text-slate-400">Loading recommendations...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    if (!token) window.location.href = '/login';

    document.addEventListener('DOMContentLoaded', async () => {
        await loadRiskScore();
        await loadTrends();
    });

    async function loadRiskScore() {
        try {
            const res = await fetch('/api/health/risk', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();

            if (res.ok) {
                // Update Score
                document.getElementById('score-val').textContent = Math.round(data.score) || '--';

                // Update specific text if available
                if (data.level) {
                    document.getElementById('score-text').textContent = data.level + ' Risk Profile';
                }

                // Update Analysis Text
                if (data.derived_metrics && data.derived_metrics.summary) {
                    document.getElementById('analysis-text').textContent = data.derived_metrics.summary;
                } else if (data.factors && data.factors.length > 0) {
                    document.getElementById('analysis-text').textContent = "Key factors: " + data.factors.join(', ');
                } else {
                    document.getElementById('analysis-text').textContent = (Math.round(data.score) > 0) ? "Your health metrics are being analyzed." : "No sufficient data for risk analysis yet.";
                }

                // Update Recommendation Text
                const recContainer = document.getElementById('ai-recs');
                // derived_metrics might have recommendations, or we fallback to generic logic
                let recs = [];
                if (data.derived_metrics && data.derived_metrics.recommendations) {
                    recs = data.derived_metrics.recommendations;
                } else {
                    // Fallback based on factors
                    if (data.factors.includes('High Blood Pressure')) recs.push('Limit sodium intake and monitor BP.');
                    if (data.factors.includes('High Heart Rate')) recs.push('Consider cardio exercises and stress management.');
                }

                if (recs.length > 0) {
                    recContainer.innerHTML = recs.map(r => `
                        <div class="p-4 rounded-xl bg-gradient-to-r from-slate-800 to-slate-900 border border-white/5 hover:border-indigo-500/50 transition">
                            <h4 class="text-white font-semibold"><i class="fa-solid fa-check-circle text-indigo-400 mr-2"></i>Suggestion</h4>
                            <p class="text-slate-400 text-sm mt-1">${r}</p>
                        </div>
                     `).join('');
                } else {
                    recContainer.innerHTML = '<p class="text-slate-400">Keep logging data, or ensure profile is complete to get personalized insights.</p>';
                }
            }
        } catch (err) { console.error('Risk API error:', err); }
    }

    async function loadTrends() {
        try {
            const res = await fetch('/api/health/logs', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const logs = await res.json();

            console.log("Logs loaded:", logs.length);

            if (!res.ok || logs.length === 0) {
                const ctx = document.getElementById('trendChart');
                // Maybe show "No data" message overlaid/in canvas?
                return;
            }

            // Process data (reverse to show oldest to newest if API returns newest first)
            // Sorting by timestamp to be safe
            const data = logs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)).slice(-10); // Last 10 entries for cleaner chart

            const labels = data.map(d => new Date(d.timestamp).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
            const hrData = data.map(d => d.heart_rate);
            const sysData = data.map(d => d.bp_systolic);
            const diaData = data.map(d => d.bp_diastolic);
            const sugarData = data.map(d => d.blood_sugar);

            const ctx = document.getElementById('trendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Heart Rate',
                            data: hrData,
                            borderColor: '#fb7185', // rose-400
                            backgroundColor: 'rgba(251, 113, 133, 0.2)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Systolic BP',
                            data: sysData,
                            borderColor: '#60a5fa', // blue-400
                            backgroundColor: 'rgba(96, 165, 250, 0.2)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Glucose',
                            data: sugarData,
                            borderColor: '#34d399', // emerald-400
                            backgroundColor: 'rgba(52, 211, 153, 0.2)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#94a3b8' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false }, // only want the grid lines for one axis to show up
                            ticks: { color: '#34d399' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });

        } catch (err) { console.error('Trends error:', err); }
    }
</script>
{% endblock %}