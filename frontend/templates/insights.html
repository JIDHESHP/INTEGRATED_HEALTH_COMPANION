{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-4xl font-bold mb-8 gradient-text">
            <i class="fa-solid fa-brain mr-3"></i>AI Health Insights
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Wellness Score -->
            <div class="glass-card p-6 flex flex-col items-center justify-center text-center relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent"></div>
                <div class="relative z-10">
                    <div
                        class="w-32 h-32 rounded-full border-4 border-emerald-500/30 flex items-center justify-center mb-4 relative">
                        <span class="text-4xl font-bold text-white" id="score-val">--</span>
                        <svg class="absolute inset-0 w-full h-full transform -rotate-90">
                            <circle cx="60" cy="60" r="58" stroke="currentColor" stroke-width="4" fill="none"
                                class="text-emerald-500" stroke-dasharray="365" stroke-dashoffset="55" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-white">Risk Score</h3>
                    <p class="text-emerald-400 text-sm font-medium" id="score-text">Analysis Pending</p>
                </div>
            </div>

            <!-- Health Factors (BMI & Vitals) -->
            <div class="glass-card p-6 relative overflow-hidden">
                <h3 class="text-xl font-bold text-white mb-4">Key Metrics</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center border-b border-white/5 pb-2">
                        <span class="text-slate-400">BMI</span>
                        <span class="text-white font-semibold" id="bmi-val">--</span>
                    </div>
                    <div class="flex justify-between items-center border-b border-white/5 pb-2">
                        <span class="text-slate-400">Heart Rate</span>
                        <span class="text-white font-semibold" id="hr-val">--</span>
                    </div>
                    <div class="flex justify-between items-center border-b border-white/5 pb-2">
                        <span class="text-slate-400">Blood Pressure</span>
                        <span class="text-white font-semibold" id="bp-val">--</span>
                    </div>
                </div>
            </div>

            <!-- AI Summary -->
            <div class="glass-card p-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-6 opacity-5">
                    <i class="fa-solid fa-robot text-8xl"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-4">AI Analysis</h3>
                <div class="space-y-4">
                    <p class="text-slate-300 leading-relaxed text-sm" id="analysis-text">
                        Processing your health data through ML models...
                    </p>
                    <div class="flex flex-wrap gap-2" id="analysis-tags">
                        <!-- Tags inserted by JS -->
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Trends Analysis -->
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold text-white mb-6">Trend Analysis</h3>
                <div class="h-64 rounded-xl border border-white/5 p-2 bg-slate-900/50">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold text-white mb-6">Recommendations</h3>
                <div id="ai-recs" class="space-y-4">
                    <p class="text-slate-400">Loading recommendations...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    if (!token) window.location.href = '/login';

    document.addEventListener('DOMContentLoaded', async () => {
        await loadRiskScore();
        await loadTrends();
    });

    async function loadRiskScore() {
        try {
            const res = await fetch('/api/health/risk', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();

            // Also fetch profile for BMI
            const profRes = await fetch('/api/profile', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const profile = await profRes.json();

            if (res.ok) {
                // Update Score
                document.getElementById('score-val').textContent = Math.round(data.score) || 0;

                // Update specific text if available
                if (data.level) {
                    document.getElementById('score-text').textContent = data.level + ' Risk Profile';
                    const scoreElem = document.getElementById('score-text');
                    scoreElem.className = 'text-sm font-medium ' + (data.level === 'High' ? 'text-rose-400' : (data.level === 'Moderate' ? 'text-yellow-400' : 'text-emerald-400'));
                }

                // Update Key Metrics
                if (profile.bmi) {
                    const bmi = profile.bmi;
                    let bmiText = bmi + ' ';
                    if (bmi > 30) bmiText += '(Obese)';
                    else if (bmi > 25) bmiText += '(Overweight)';
                    else if (bmi < 18.5) bmiText += '(Underweight)';
                    else bmiText += '(Normal)';
                    document.getElementById('bmi-val').textContent = bmiText;
                    // Color code
                    document.getElementById('bmi-val').className = 'font-semibold ' + (bmi > 25 ? 'text-yellow-400' : 'text-emerald-400');
                }

                // Derived vital display from analysis
                if (data.derived_metrics && data.derived_metrics.key_vitals_summary) {
                    // Parse rudimentary summary if simple string, or just look at tags
                }

                // Wait for trends to load exact values or we can use the insights summary

                // Update Analysis Text
                if (data.insights && data.insights.risk_explanation) {
                    document.getElementById('analysis-text').textContent = data.insights.risk_explanation;
                } else if (data.factors && data.factors.length > 0) {
                    document.getElementById('analysis-text').textContent = "Risk Factors Identified: " + data.factors.join(', ');
                } else {
                    document.getElementById('analysis-text').textContent = "Your health metrics indicate a low risk profile. Keep up the good work!";
                }

                // Update tags
                const tagsContainer = document.getElementById('analysis-tags');
                tagsContainer.innerHTML = '';
                if (data.factors) {
                    data.factors.forEach(f => {
                        tagsContainer.innerHTML += `<span class="px-3 py-1 bg-rose-500/20 text-rose-300 rounded-full text-xs border border-rose-500/30">${f}</span>`;
                    });
                }

                // Update Recommendation Text
                const recContainer = document.getElementById('ai-recs');
                let recs = [];
                if (data.insights && data.insights.improvement_suggestions) {
                    recs = data.insights.improvement_suggestions;
                } else if (data.derived_metrics && data.derived_metrics.recommendations) {
                    recs = data.derived_metrics.recommendations;
                } else {
                    if (data.factors.includes('High Blood Pressure')) recs.push('Limit sodium intake and monitor BP.');
                    if (data.factors.includes('High Heart Rate')) recs.push('Consider cardio exercises and stress management.');
                }

                if (recs.length > 0) {
                    recContainer.innerHTML = recs.map(r => `
                        <div class="p-4 rounded-xl bg-gradient-to-r from-slate-800 to-slate-900 border border-white/5 hover:border-indigo-500/50 transition">
                            <h4 class="text-white font-semibold"><i class="fa-solid fa-check-circle text-indigo-400 mr-2"></i>Suggestion</h4>
                            <p class="text-slate-400 text-sm mt-1">${r}</p>
                        </div>
                     `).join('');
                } else {
                    recContainer.innerHTML = '<div class="p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20"><p class="text-emerald-300">Great job! No specific improvements needed based on current data.</p></div>';
                }
            }
        } catch (err) { console.error('Risk API error:', err); }
    }

    async function loadTrends() {
        try {
            const res = await fetch('/api/health/logs', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const logs = await res.json();

            console.log("Logs loaded:", logs.length);

            if (!res.ok || logs.length === 0) {
                const ctx = document.getElementById('trendChart');
                // Maybe show "No data" message overlaid/in canvas?
                return;
            }

            // Process data (reverse to show oldest to newest if API returns newest first)
            // Sorting by timestamp to be safe
            const data = logs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)).slice(-10); // Last 10 entries for cleaner chart

            const labels = data.map(d => new Date(d.timestamp).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
            const hrData = data.map(d => d.heart_rate);
            const sysData = data.map(d => d.bp_systolic);
            const diaData = data.map(d => d.bp_diastolic);
            const sugarData = data.map(d => d.blood_sugar);

            const ctx = document.getElementById('trendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Heart Rate',
                            data: hrData,
                            borderColor: '#fb7185', // rose-400
                            backgroundColor: 'rgba(251, 113, 133, 0.2)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Systolic BP',
                            data: sysData,
                            borderColor: '#60a5fa', // blue-400
                            backgroundColor: 'rgba(96, 165, 250, 0.2)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Glucose',
                            data: sugarData,
                            borderColor: '#34d399', // emerald-400
                            backgroundColor: 'rgba(52, 211, 153, 0.2)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#94a3b8' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false }, // only want the grid lines for one axis to show up
                            ticks: { color: '#34d399' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });

        } catch (err) { console.error('Trends error:', err); }
    }
</script>
{% endblock %}