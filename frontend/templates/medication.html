{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-teal-600 via-cyan-600 to-blue-600 relative overflow-hidden">
    <!-- Animated Background -->
    <div class="absolute inset-0 opacity-20">
        <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ffffff\' fill-opacity=\'0.1\'%3E%3Cpath d=\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')] animate-pulse"></div>
    </div>

    <div class="container mx-auto px-4 py-8 relative z-10">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="inline-block p-4 bg-gradient-to-br from-teal-500 to-cyan-500 rounded-full mb-4">
                    <i class="fa-solid fa-pills text-white text-5xl"></i>
                </div>
                <h1 class="text-4xl md:text-5xl font-bold mb-4 gradient-text">Medication Schedule ðŸ’Š</h1>
                <p class="text-gray-200 text-lg">Manage your medication reminders</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Add Medication Form -->
                <div class="glass-card p-8 shadow-2xl">
                    <h2 class="text-2xl font-bold text-white mb-6">
                        <i class="fa-solid fa-plus-circle mr-2"></i>Add Medication
                    </h2>
                    <form id="medication-form" class="space-y-6">
                        <div>
                            <label class="block text-gray-300 mb-2 font-semibold">
                                <i class="fa-solid fa-capsules mr-2 text-primary"></i>Medication Name
                            </label>
                            <input type="text" id="m-name" placeholder="e.g. Aspirin"
                                class="w-full bg-gray-800/50 border-2 border-gray-700 rounded-lg p-4 text-white focus:outline-none focus:border-primary transition" required>
                        </div>
                        <div>
                            <label class="block text-gray-300 mb-2 font-semibold">
                                <i class="fa-solid fa-weight-hanging mr-2 text-primary"></i>Dosage
                            </label>
                            <input type="text" id="m-dosage" placeholder="e.g. 500mg"
                                class="w-full bg-gray-800/50 border-2 border-gray-700 rounded-lg p-4 text-white focus:outline-none focus:border-primary transition" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-300 mb-2 font-semibold">
                                    <i class="fa-solid fa-repeat mr-2 text-primary"></i>Frequency
                                </label>
                                <select id="m-frequency"
                                    class="w-full bg-gray-800/50 border-2 border-gray-700 rounded-lg p-4 text-white focus:outline-none focus:border-primary transition">
                                    <option value="Daily">Daily</option>
                                    <option value="Twice Daily">Twice Daily</option>
                                    <option value="Three Times Daily">Three Times Daily</option>
                                    <option value="Weekly">Weekly</option>
                                    <option value="As Needed">As Needed</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2 font-semibold">
                                    <i class="fa-solid fa-clock mr-2 text-primary"></i>Time
                                </label>
                                <input type="time" id="m-time"
                                    class="w-full bg-gray-800/50 border-2 border-gray-700 rounded-lg p-4 text-white focus:outline-none focus:border-primary transition" required>
                            </div>
                        </div>
                        <button type="submit"
                            class="w-full bg-gradient-to-r from-primary to-cyan-600 hover:from-indigo-600 hover:to-cyan-700 text-white font-bold py-4 rounded-lg transition transform hover:scale-105 shadow-lg">
                            <i class="fa-solid fa-plus mr-2"></i>Add Medication
                        </button>
                    </form>

                    <!-- Success Message -->
                    <div id="save-success" class="hidden mt-4 p-4 bg-green-500/20 border border-green-500 rounded-lg">
                        <p class="text-green-300 font-semibold">
                            <i class="fa-solid fa-check-circle mr-2"></i>Medication added successfully!
                        </p>
                    </div>
                </div>

                <!-- Medication List -->
                <div class="glass-card p-8 shadow-2xl">
                    <h2 class="text-2xl font-bold text-white mb-6">
                        <i class="fa-solid fa-list mr-2"></i>Your Schedule
                    </h2>
                    <div id="medication-list" class="space-y-4 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
                        <div class="text-center py-8">
                            <i class="fa-solid fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-400">Loading medications...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const state = {
    token: localStorage.getItem('token')
};

if (!state.token) {
    window.location.href = '/login';
}

// Load medications on page load
document.addEventListener('DOMContentLoaded', () => {
    fetchMedications();
});

// Form submission
document.getElementById('medication-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        name: document.getElementById('m-name').value,
        dosage: document.getElementById('m-dosage').value,
        frequency: document.getElementById('m-frequency').value,
        time: document.getElementById('m-time').value
    };
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Adding...';

    try {
        const res = await fetch('/api/medication', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${state.token}`
            },
            body: JSON.stringify(data)
        });
        
        if (res.ok) {
            const successMsg = document.getElementById('save-success');
            successMsg.classList.remove('hidden');
            setTimeout(() => successMsg.classList.add('hidden'), 3000);
            
            e.target.reset();
            fetchMedications();
        } else {
            const result = await res.json();
            alert('Error: ' + result.msg);
        }
    } catch (err) {
        console.error(err);
        alert('Failed to add medication');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    }
});

async function fetchMedications() {
    try {
        const res = await fetch('/api/medication', {
            headers: { 'Authorization': `Bearer ${state.token}` }
        });
        const data = await res.json();
        renderMedications(data);
    } catch (err) {
        console.error('Failed to fetch medications:', err);
    }
}

function renderMedications(meds) {
    const list = document.getElementById('medication-list');
    list.innerHTML = '';
    
    if (meds.length === 0) {
        list.innerHTML = `
            <div class="text-center py-12">
                <i class="fa-solid fa-pills text-6xl text-gray-500 mb-4"></i>
                <p class="text-gray-400 text-lg">No medications scheduled</p>
                <p class="text-gray-500 text-sm mt-2">Add your first medication to get started</p>
            </div>
        `;
        return;
    }
    
    meds.forEach(med => {
        const el = document.createElement('div');
        el.className = 'bg-gradient-to-r from-gray-800/50 to-gray-700/50 p-5 rounded-lg border-l-4 border-primary hover:shadow-lg transition';
        el.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center mb-2">
                        <i class="fa-solid fa-capsules text-primary text-xl mr-3"></i>
                        <h4 class="font-bold text-white text-lg">${med.name}</h4>
                    </div>
                    <div class="ml-8 space-y-1">
                        <p class="text-gray-300"><i class="fa-solid fa-weight-hanging mr-2 text-gray-400"></i>${med.dosage}</p>
                        <p class="text-gray-300"><i class="fa-solid fa-clock mr-2 text-gray-400"></i>${med.time} â€¢ ${med.frequency}</p>
                    </div>
                </div>
                <button onclick="deleteMed('${med._id}')" 
                    class="ml-4 p-2 text-gray-400 hover:text-red-400 hover:bg-red-500/20 rounded-lg transition">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        `;
        list.appendChild(el);
    });
}

window.deleteMed = async function(id) {
    if(!confirm('Remove this medication from your schedule?')) return;
    try {
        await fetch(`/api/medication/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${state.token}` }
        });
        fetchMedications();
    } catch (err) {
        console.error(err);
        alert('Failed to delete medication');
    }
};
</script>
{% endblock %}

