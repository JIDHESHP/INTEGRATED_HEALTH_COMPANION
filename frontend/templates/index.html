{% extends "base.html" %}

{% block content %}
<!-- Dashboard Content (Authenticated) -->
<div id="dashboard-content"
    class="container mx-auto px-4 py-8 space-y-8 hidden opacity-0 transition-opacity duration-500">

    <!-- Hero Section with Digital Clock -->
    <div class="relative overflow-hidden rounded-3xl glass-card p-8 md:p-12 mb-8 text-center">
        <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-r from-indigo-500/10 to-purple-500/10 z-0"></div>
        <div class="relative z-10">
            <h1 class="text-3xl md:text-5xl font-bold mb-4">
                Welcome back, <span id="user-display-name" class="gradient-text">User</span>
            </h1>
            <p class="text-slate-400 text-lg mb-8">Your health metrics at a glance</p>

            <!-- Digital Clock Widget -->
            <div
                class="inline-flex flex-col items-center justify-center p-8 rounded-2xl bg-white/5 border border-white/10 backdrop-blur-md shadow-2xl">
                <div id="digital-clock"
                    class="text-6xl md:text-8xl font-mono font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 tracking-wider"
                    style="text-shadow: 0 0 30px rgba(52, 211, 153, 0.2);">
                    --:--:--
                </div>
                <div id="current-date"
                    class="mt-4 text-xl md:text-2xl text-slate-300 font-light tracking-widest uppercase">
                    Loading Date...
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Risk Score -->
        <a href="/risk"
            class="glass-card p-6 group hover:bg-white/5 transition duration-300 border-l-4 border-yellow-500 relative overflow-hidden">
            <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition">
                <i class="fa-solid fa-shield-heart text-6xl text-yellow-500"></i>
            </div>
            <h3 class="text-slate-400 text-sm font-semibold uppercase tracking-wider">Health Risk</h3>
            <div class="mt-2 flex items-baseline">
                <span class="text-3xl font-bold text-white" id="risk-score-display">--</span>
                <span class="ml-2 text-sm text-yellow-500 font-medium" id="risk-label">Analyzing...</span>
            </div>
            <div class="mt-4 flex items-center text-xs text-slate-500 group-hover:text-slate-300">
                <span>View Details</span>
                <i
                    class="fa-solid fa-arrow-right ml-2 opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition"></i>
            </div>
        </a>

        <!-- Heart Rate -->
        <div class="glass-card p-6 border-l-4 border-rose-500 relative overflow-hidden">
            <div class="absolute right-0 top-0 p-4 opacity-10">
                <i class="fa-solid fa-heart-pulse text-6xl text-rose-500"></i>
            </div>
            <h3 class="text-slate-400 text-sm font-semibold uppercase tracking-wider">Heart Rate</h3>
            <div class="mt-2">
                <span class="text-3xl font-bold text-white" id="display-hr">--</span>
                <span class="text-lg text-rose-400 font-medium">bpm</span>
            </div>
            <p class="mt-4 text-xs text-slate-500">Latest recorded reading</p>
        </div>

        <!-- Blood Pressure -->
        <div class="glass-card p-6 border-l-4 border-blue-500 relative overflow-hidden">
            <div class="absolute right-0 top-0 p-4 opacity-10">
                <i class="fa-solid fa-droplet text-6xl text-blue-500"></i>
            </div>
            <h3 class="text-slate-400 text-sm font-semibold uppercase tracking-wider">Blood Pressure</h3>
            <div class="mt-2">
                <span class="text-3xl font-bold text-white" id="display-bp">--/--</span>
                <span class="text-lg text-blue-400 font-medium">mmHg</span>
            </div>
            <p class="mt-4 text-xs text-slate-500">Systolic / Diastolic</p>
        </div>

        <!-- Enter Vitals Action -->
        <a href="/vitals"
            class="glass-card p-6 group hover:bg-emerald-500/10 transition duration-300 border-l-4 border-emerald-500 flex flex-col justify-center items-center text-center cursor-pointer">
            <div
                class="w-12 h-12 rounded-full bg-emerald-500/20 flex items-center justify-center mb-3 group-hover:scale-110 transition">
                <i class="fa-solid fa-plus text-emerald-400 text-xl"></i>
            </div>
            <h3 class="text-white font-bold text-lg">Log Vitals</h3>
            <p class="text-xs text-slate-400 mt-1 mb-3">Update your health stats</p>
        </a>
    </div>

    <!-- Quick Links / Features -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <a href="/insights"
            class="glass-card p-8 hover:-translate-y-1 hover:shadow-lg hover:shadow-indigo-500/10 transition duration-300">
            <div class="w-14 h-14 rounded-2xl bg-indigo-500/20 flex items-center justify-center mb-6">
                <i class="fa-solid fa-brain text-indigo-400 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">AI Insights</h3>
            <p class="text-slate-400 text-sm leading-relaxed">
                Get personalized health recommendations and anomaly detection powered by advanced AI models.
            </p>
        </a>

        <a href="/medication"
            class="glass-card p-8 hover:-translate-y-1 hover:shadow-lg hover:shadow-pink-500/10 transition duration-300">
            <div class="w-14 h-14 rounded-2xl bg-pink-500/20 flex items-center justify-center mb-6">
                <i class="fa-solid fa-pills text-pink-400 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Medication</h3>
            <p class="text-slate-400 text-sm leading-relaxed">
                Manage your prescriptions, set reminders, and track adherence to your medical schedule.
            </p>
        </a>

        <a href="/health_trends"
            class="glass-card p-8 hover:-translate-y-1 hover:shadow-lg hover:shadow-cyan-500/10 transition duration-300">
            <div class="w-14 h-14 rounded-2xl bg-cyan-500/20 flex items-center justify-center mb-6">
                <i class="fa-solid fa-chart-line text-cyan-400 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Health Trends</h3>
            <p class="text-slate-400 text-sm leading-relaxed">
                Visualize your progress over time with interactive charts and detailed history logs.
            </p>
        </a>
    </div>
</div>

<!-- Landing Content (Unauthenticated) -->
<div id="landing-content"
    class="min-h-[80vh] flex flex-col items-center justify-center text-center px-4 relative z-10 hidden">
    <div class="glass-card p-12 md:p-16 max-w-4xl w-full relative overflow-hidden backdrop-blur-xl">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>

        <h1 class="text-5xl md:text-7xl font-bold mb-6 tracking-tight">
            <span class="gradient-text">Smart Wellness</span>
        </h1>
        <p class="text-xl text-slate-300 mb-10 max-w-2xl mx-auto leading-relaxed">
            Your intelligent health companion. Monitor vitals, predict risks, and receive personalized care insights.
        </p>

        <div class="flex flex-col sm:flex-row justify-center gap-6">
            <a href="/register"
                class="px-8 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 rounded-xl text-white font-bold text-lg transition transform hover:scale-105 shadow-xl shadow-indigo-500/20">
                Get Started
            </a>
            <a href="/login"
                class="px-8 py-4 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-white font-bold text-lg transition backdrop-blur-sm">
                Login
            </a>
        </div>

        <!-- Feature Pills -->
        <div class="mt-12 flex flex-wrap justify-center gap-4">
            <span class="px-4 py-2 rounded-full bg-white/5 border border-white/5 text-sm text-slate-400">
                <i class="fa-solid fa-check-circle text-emerald-400 mr-2"></i>Real-time Monitoring
            </span>
            <span class="px-4 py-2 rounded-full bg-white/5 border border-white/5 text-sm text-slate-400">
                <i class="fa-solid fa-check-circle text-emerald-400 mr-2"></i>AI Risk Assessment
            </span>
            <span class="px-4 py-2 rounded-full bg-white/5 border border-white/5 text-sm text-slate-400">
                <i class="fa-solid fa-check-circle text-emerald-400 mr-2"></i>Secure Data
            </span>
        </div>
    </div>
</div>

<script>
    // Digital Clock Logic
    function updateClock() {
        const now = new Date();

        // Time 12hr format with seconds
        let hours = now.getHours();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        // hours = hours % 12;
        // hours = hours ? hours : 12; // the hour '0' should be '12'
        // Keeping 24hr format as per commonly used digital clock style in prompts, or 12? 
        // Let's do 12hr as it's friendlier.

        const timeString = now.toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });

        // Date
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const dateString = now.toLocaleDateString('en-US', options);

        const clockEl = document.getElementById('digital-clock');
        const dateEl = document.getElementById('current-date');

        if (clockEl) clockEl.innerText = timeString;
        if (dateEl) dateEl.innerText = dateString;
    }

    setInterval(updateClock, 1000);
    updateClock(); // Initial call

    // Auth Check
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        const dashboard = document.getElementById('dashboard-content');
        const landing = document.getElementById('landing-content');

        if (token) {
            dashboard.classList.remove('hidden');
            // Fade in
            setTimeout(() => dashboard.classList.remove('opacity-0'), 100);
            landing.classList.add('hidden');

            // Load User Data
            loadDashboardData(token);
        } else {
            landing.classList.remove('hidden');
            dashboard.classList.add('hidden');
        }
    });

    async function loadDashboardData(token) {
        try {
            // Get specific profile/health endpoints if needed, 
            // but for now relying on risk/latest endpoints

            // Fetch Latest Vitals
            const resVitals = await fetch('/api/health/latest', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const vitals = await resVitals.json();

            if (vitals) {
                if (vitals.heart_rate) document.getElementById('display-hr').innerText = vitals.heart_rate;
                if (vitals.bp_systolic) document.getElementById('display-bp').innerText = `${vitals.bp_systolic}/${vitals.bp_diastolic}`;
            }

            // Fetch Risk Score (simplified fetch)
            const resRisk = await fetch('/api/health/risk', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const riskData = await resRisk.json();

            if (riskData && riskData.score !== undefined) {
                const scoreEl = document.getElementById('risk-score-display');
                const labelEl = document.getElementById('risk-label');
                scoreEl.innerText = riskData.score;

                // Color coding
                if (riskData.score > 60) {
                    scoreEl.classList.add('text-rose-500');
                    scoreEl.classList.remove('text-white');
                    labelEl.innerText = 'High Risk';
                    labelEl.className = 'ml-2 text-sm text-rose-500 font-medium';
                } else if (riskData.score > 30) {
                    scoreEl.classList.add('text-yellow-500');
                    scoreEl.classList.remove('text-white');
                    labelEl.innerText = 'Moderate Risk';
                    labelEl.className = 'ml-2 text-sm text-yellow-500 font-medium';
                } else {
                    scoreEl.classList.add('text-emerald-500');
                    scoreEl.classList.remove('text-white');
                    labelEl.innerText = 'Low Risk';
                    labelEl.className = 'ml-2 text-sm text-emerald-500 font-medium';
                }
            }

            // Get Username (Profile)
            const resProfile = await fetch('/api/profile', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (resProfile.ok) {
                const profile = await resProfile.json();
                if (profile.name) {
                    document.getElementById('user-display-name').innerText = profile.name;
                }
            }

        } catch (err) {
            console.error(err);
        }
    }
</script>
{% endblock %}